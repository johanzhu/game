function onWindowResize(){WIDTH=window.innerWidth,HEIGHT=window.innerHeight,renderer.setSize(WIDTH,HEIGHT),camera0.aspect=WIDTH/HEIGHT,camera0.updateProjectionMatrix(),camera1.aspect=WIDTH/HEIGHT,camera1.updateProjectionMatrix(),camera2.aspect=WIDTH/HEIGHT,camera2.updateProjectionMatrix(),camera3.aspect=WIDTH/HEIGHT,camera3.updateProjectionMatrix(),camera4.aspect=WIDTH/HEIGHT,camera4.updateProjectionMatrix()}function generateRedMushRoom(){var e=redMushroom.clone();e.position.x=range(-59.5,59.5),e.position.z=range(-38.5,38.5),e.position.y=1,scene4.add(e)}function generateGreenMushRoom(){var e=greenMushroom.clone();e.position.x=range(-59.5,59.5),e.position.z=range(-38.5,38.5),e.position.y=1,scene4.add(e)}function generateGoldMushRoom(){var e=goldMushroom.clone();e.position.x=range(-59.5,59.5),e.position.z=range(-38.5,38.5),e.position.y=1,scene4.add(e)}function generateTrainOnRail1(){var e=train.clone();e.position.x=60.5,e.position.z=-83;var n=new TWEEN.Tween(e.position).to({z:93},5e3),a=new TWEEN.Tween(e.position).to({z:-83},1);n.chain(a),a.chain(n),n.start(),scene4.add(e)}function generateTrainOnRail2(){var e=train.clone();e.position.x=26.5,e.position.z=-83;var n=new TWEEN.Tween(e.position).to({z:93},4e3).delay(4e3),a=new TWEEN.Tween(e.position).to({z:-83},1);n.chain(a),a.chain(n),n.start(),scene4.add(e)}function generateTrainOnRail3(){var e=train.clone();e.position.x=-7.5,e.position.z=-83;var n=new TWEEN.Tween(e.position).to({z:93},4e3),a=new TWEEN.Tween(e.position).to({z:-83},1).delay(2e3);n.chain(a),a.chain(n),n.start(),scene4.add(e)}function generateTrainOnRail4(){var e=train.clone();e.position.x=-41.5,e.position.z=-83;var n=new TWEEN.Tween(e.position).to({z:93},4e3).delay(3e3),a=new TWEEN.Tween(e.position).to({z:-83},1);n.chain(a),a.chain(n),n.start(),scene4.add(e)}function animate(){requestAnimationFrame(animate),render(),collide()}function render(){if(1==loading&&(load.style.display="none"),scene=scene0,camera=camera0,!0===selected&&("brave"===character[0]?(scene=scene1,camera=camera1,mixer0.clipAction(sceneAnimationClip).play(),scene4.remove(mage),scene4.remove(priest)):"mage"===character[0]?(scene=scene2,camera=camera2,mixer1.clipAction(sceneAnimationClip).play(),scene4.remove(brave),scene4.remove(priest)):"priest"===character[0]&&(scene=scene3,camera=camera3,mixer2.clipAction(sceneAnimationClip).play(),scene4.remove(brave),scene4.remove(mage))),!0===gameBegin)switch(scene=scene4,camera=camera4,character[0]){case"brave":characterModel=brave;break;case"mage":characterModel=mage;break;case"priest":characterModel=priest}var e=clock.getDelta();mixer0&&mixer1&&mixer2&&(mixer0.update(e),mixer1.update(e),mixer2.update(e)),mixerBrave&&mixerBrave.update(e),mixerMage&&mixerMage.update(e),mixerPriest&&mixerPriest.update(e),TWEEN.update(),tipsShow&&(document.getElementById("tips").style.display="block"),scoreShow&&(document.getElementById("score").style.display="block"),HPShow&&((n=document.getElementById("HP")).style.display="block"),skillShow&&(document.getElementById("skill").style.display="block");var n=document.getElementById("HPNum");0==parseInt(n.innerHTML)&&gameOver(),renderer.render(scene,camera)}function chooseBrave(){selected=!0,character.push("brave");var e=document.getElementById("vocationDes");document.getElementById("start").style.display="block",document.body.removeChild(e)}function chooseMage(){selected=!0,character.push("mage");var e=document.getElementById("vocationDes");document.getElementById("start").style.display="block",document.body.removeChild(e)}function choosePriest(){selected=!0,character.push("priest");var e=document.getElementById("vocationDes");document.getElementById("start").style.display="block",document.body.removeChild(e)}function addBrave(){new THREE.JSONLoader(manager).load("./action/Zwalk.json",function(e,n){for(var a=0;a<n.length;a++)n[a].morphTargets=!0;model1=new THREE.Mesh(e,n[0]),brave=new THREE.Object3D,brave.name="brave",model1.position.y=1,brave.add(model1),scene4.add(brave),mixerBrave=new THREE.AnimationMixer(model1);var o=THREE.AnimationClip.CreateFromMorphTargetSequence("brave",e.morphTargets,60);action1=mixerBrave.clipAction(o),action1.setDuration(1)})}function addMage(){new THREE.JSONLoader(manager).load("./action/Fwalk.json",function(e,n){for(var a=0;a<n.length;a++)n[a].morphTargets=!0;model2=new THREE.Mesh(e,n[0]),mage=model2,mage.name="name",model2.position.y=-.1,scene4.add(mage),mixerMage=new THREE.AnimationMixer(model2);var o=THREE.AnimationClip.CreateFromMorphTargetSequence("mage",e.morphTargets,60);action2=mixerMage.clipAction(o),action2.setDuration(1)})}function addPriest(){new THREE.JSONLoader(manager).load("./action/Mwalk.json",function(e,n){for(var a=0;a<n.length;a++)n[a].morphTargets=!0;model3=new THREE.Mesh(e,n[0]),priest=new THREE.Object3D,priest.name="priest",model3.position.y=1,priest.add(model3),scene4.add(priest),mixerPriest=new THREE.AnimationMixer(model3);var o=THREE.AnimationClip.CreateFromMorphTargetSequence("priest",e.morphTargets,60);action3=mixerPriest.clipAction(o),action3.setDuration(1)})}function moveForward(){character[0]&&("brave"!=character[0]&&"priest"!=character[0]||run.play(),"priest"==character[0]&&(walkStep=1)),characterModel.rotation.y=Math.PI/2,model1.rotation.x=Math.PI*(22/180),characterModel.position.x+=walkStep}function moveBack(){character[0]&&("brave"!=character[0]&&"priest"!=character[0]||run.play(),"priest"==character[0]&&(walkStep=1)),characterModel.rotation.y=-Math.PI/2,model1.rotation.x=Math.PI*(22/180),characterModel.position.x-=walkStep}function moveLeft(){character[0]&&("brave"!=character[0]&&"priest"!=character[0]||run.play(),"priest"==character[0]&&(walkStep=1)),characterModel.rotation.y=Math.PI,model1.rotation.x=Math.PI*(22/180),characterModel.position.z-=walkStep}function moveRight(){character[0]&&("brave"!=character[0]&&"priest"!=character[0]||run.play(),"priest"==character[0]&&(walkStep=1)),characterModel.rotation.y=0,model1.rotation.x=Math.PI*(22/180),characterModel.position.z+=walkStep}function useSkill(){if(character[0])switch(character[0]){case"brave":run=document.getElementById("run"),run.addEventListener("ended",function(){run.currentTime=0}),walkStep=2;break;case"mage":var e=characterModel.rotation.y;console.log(e),e?e==Math.PI/2?characterModel.position.x+=34:e==-Math.PI/2?characterModel.position.x-=34:e==Math.PI?characterModel.position.z-=34:characterModel.position.z+=34:characterModel.position.z+=34;var n=document.getElementById("flash");n.addEventListener("ended",function(){n.currentTime=0}),n.play();break;case"priest":var a=document.getElementById("heal");a.addEventListener("ended",function(){a.currentTime=0}),a.play();var o=document.getElementById("HPNum"),t=parseInt(o.innerHTML);t<3&&(o.innerHTML=t+1)}}function collide(){var e;if(characterModel){var n=characterModel.position.x,a=characterModel.position.y,o=characterModel.position.z;switch(characterModel){case brave:var t=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(1,5,0),0,3.5),r=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(-1,5,0),0,3.5),i=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(0,5,1),0,3.5),c=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(0,5,-1),0,3.5);break;case mage:var t=new THREE.Raycaster(new THREE.Vector3(n,a+3.5,o),new THREE.Vector3(1,3.5,0),0,3.5),r=new THREE.Raycaster(new THREE.Vector3(n,a+3.5,o),new THREE.Vector3(-1,3.5,0),0,3.5),i=new THREE.Raycaster(new THREE.Vector3(n,a+3.5,o),new THREE.Vector3(0,3.5,1),0,3.5),c=new THREE.Raycaster(new THREE.Vector3(n,a+3.5,o),new THREE.Vector3(0,3.5,-1),0,3.5);break;case priest:var t=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(1,5,0),0,4),r=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(-1,5,0),0,4),i=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(0,5,1),0,4),c=new THREE.Raycaster(new THREE.Vector3(n,a+5,o),new THREE.Vector3(0,5,-1),0,4)}var s=t.intersectObjects(scene4.children),d=r.intersectObjects(scene4.children),l=i.intersectObjects(scene4.children),m=c.intersectObjects(scene4.children);if(s.length>0&&(console.log("forward hit"),e=s[0].object),d.length>0&&(console.log("back hit"),e=d[0].object),l.length>0&&(console.log("right hit"),e=l[0].object),m.length>0&&(console.log("left hit"),e=m[0].object),e)switch(e.name){case"red":!function(){scene4.remove(e),generateRedMushRoom();var n=document.getElementById("scoreNum"),a=parseInt(n.innerHTML);n.innerHTML=a+1}();break;case"green":!function(){scene4.remove(e),generateGreenMushRoom();var n=document.getElementById("HPNum"),a=parseInt(n.innerHTML);n.innerHTML=a-1}();break;case"gold":!function(){scene4.remove(e),generateGoldMushRoom();var n=document.getElementById("scoreNum"),a=parseInt(n.innerHTML);n.innerHTML=a+2}();break;case"train":gameOver()}}}function gameOver(){document.getElementById("gameover").style.display="block",document.getElementById("world").style.display="none",document.getElementById("score").style.opacity="0",document.getElementById("HP").style.opacity="0",document.getElementById("skill").style.opacity="0",gameBegin=!1}function range(e,n){var a=n-e,o=Math.random()*a;return Math.round(e+o)}function distance(e,n){var a=e.x,o=e.y,t=e.z,r=n.x,i=n.y,c=n.z;return dd=Math.pow(a-r,2)+Math.pow(o-i,2)+Math.pow(t-c,2),d=Math.sqrt(dd),d}var scene0,scene1,camera0,camera1,mixer0,mixer1,mixer2,mixerBrave,mixerMage,mixerPriest,model1,model2,model3,renderer,tipsShow=!1,scoreShow=!1,HPShow=!1,skillShow=!1,selected=!1;gameBegin=!1,loading=!1,character=[],characterModel=null,walkStep=.5;var globalPlane1=new THREE.Plane(new THREE.Vector3(1,0,0),63),globalPlane2=new THREE.Plane(new THREE.Vector3(-1,0,0),63),globalPlane3=new THREE.Plane(new THREE.Vector3(0,0,1),63),globalPlane4=new THREE.Plane(new THREE.Vector3(0,0,-1),63),globalPlanes=[globalPlane3,globalPlane4],manager=new THREE.LoadingManager;manager.onLoad=function(){console.log("resourse complete!"),loading=!0};var load=document.getElementById("loading");clock=new THREE.Clock,scene0=new THREE.Scene,(camera0=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,2e3)).position.set(0,5,50),camera0.lookAt(new THREE.Vector3(0,0,0)),(camera1=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,2e3)).position.set(0,5,-40),camera1.lookAt(new THREE.Vector3(0,10,0)),camera2=camera1.clone(),camera3=camera1.clone(),camera4=camera1.clone(),(renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.shadowMapEnabled=!0,renderer.localClippingEnabled=!0,renderer.clippingPlanes=globalPlanes;var container=document.getElementById("world");container.appendChild(renderer.domElement),window.addEventListener("resize",onWindowResize,!1);var ambient=new THREE.AmbientLight(4473924);ambient.intensity=3.2,scene0.add(ambient);var directionalLight=new THREE.DirectionalLight(16711680);directionalLight.position.set(-1,1,10),directionalLight.intensity=.1,scene0.add(directionalLight);var directionalLight2=new THREE.DirectionalLight(16772829);directionalLight2.position.set(1,1,10),directionalLight2.intensity=.1,scene0.add(directionalLight2);var domEvent=new THREEx.DomEvents(camera0,renderer.domElement),des=document.getElementById("vocationDes"),arrowShape=new THREE.Shape;arrowShape.moveTo(0,0),arrowShape.lineTo(-2.5,-4.325),arrowShape.lineTo(0,-2.1),arrowShape.lineTo(2.5,-4.325),arrowShape.lineTo(0,0);var options={amount:2,bevelThickness:0,bevelSize:1,bevelSegments:3,curveSegments:12,step:1},arrowGeo=new THREE.ExtrudeGeometry(arrowShape,options),arrowMat=new THREE.MeshLambertMaterial({color:16777215}),arrow=new THREE.Mesh(arrowGeo,arrowMat);arrow.scale.set(.5,.5,.5);var arrow2=arrow.clone(),arrow3=arrow.clone(),onProgress=function(e){if(e.lengthComputable)e.loaded,e.total},onError=function(e){console.log("opps..cannot find model")},mtlLoader1=new THREE.MTLLoader(manager);mtlLoader1.setPath("modelassets/"),mtlLoader1.load("chr-zhanshi.mtl",function(e){e.preload();var n=new THREE.OBJLoader(manager);n.setMaterials(e),n.setPath("modelassets/"),n.load("chr-zhanshi.obj",function(e){zhanshi=e,zhanshiBox=new THREE.Object3D,zhanshiBox.add(zhanshi),zhanshiBox.position.x-=20,arrow.position.set(-20,-12,0);var n=new TWEEN.Tween(arrow.position).to({y:-13},500),a=new TWEEN.Tween(arrow.position).to({y:-12},500);n.chain(a),a.chain(n),n.start(),scene0.add(arrow),scene0.add(zhanshiBox),zhanshiTween=new TWEEN.Tween(zhanshiBox.rotation).to({y:-2*Math.PI},2500).repeat(0),zhanshiTween.onComplete(function(){zhanshiBox.rotation.y=0}),domEvent.addEventListener(zhanshiBox,"click",function(){des.innerHTML="Brave — A powerful soldier.Skill: Charge <span>Select?</span> <span id='brave' class='choose'>Y</span>/<span>N</span>",document.getElementById("brave").addEventListener("click",chooseBrave,!1),zhanshiTween.start()}),e.position.y-=10},onProgress,onError)});var mtlLoader2=new THREE.MTLLoader(manager);mtlLoader2.setPath("modelassets/"),mtlLoader2.load("chr-fashi.mtl",function(e){e.preload();var n=new THREE.OBJLoader(manager);n.setMaterials(e),n.setPath("modelassets/"),n.load("chr-fashi.obj",function(e){fashi=e,fashi.position.x=-1,fashiBox=new THREE.Object3D,arrow2.position.set(0,-12,0);var n=new TWEEN.Tween(arrow2.position).to({y:-13},500),a=new TWEEN.Tween(arrow2.position).to({y:-12},500);n.chain(a),a.chain(n),n.start(),scene0.add(arrow2),fashiBox.add(fashi),scene0.add(fashiBox),fashiTween=new TWEEN.Tween(fashiBox.rotation).to({y:-2*Math.PI},2500).repeat(0),fashiTween.onComplete(function(){fashiBox.rotation.y=0}),domEvent.addEventListener(fashiBox,"click",function(){des.innerHTML="Mage —— A wise oracle.Skill: Flash <span>Select?</span> <span id='mage' class='choose'>Y</span>/<span>N</span>",document.getElementById("mage").addEventListener("click",chooseMage,!1),fashiTween.start()}),e.position.y-=10},onProgress,onError)});var mtlLoader3=new THREE.MTLLoader(manager);mtlLoader3.setPath("modelassets/"),mtlLoader3.load("chr-mushi.mtl",function(e){e.preload();var n=new THREE.OBJLoader(manager);n.setMaterials(e),n.setPath("modelassets/"),n.load("chr-mushi.obj",function(e){mushi=e,mushiBox=new THREE.Object3D,mushi.position.set(0,0,-3),mushiBox.add(mushi),mushiBox.position.x+=20,arrow3.position.set(20,-12,0);var n=new TWEEN.Tween(arrow3.position).to({y:-13},500),a=new TWEEN.Tween(arrow3.position).to({y:-12},500);n.chain(a),a.chain(n),n.start(),scene0.add(arrow3),scene0.add(mushiBox),mushiTween=new TWEEN.Tween(mushiBox.rotation).to({y:-2*Math.PI},2500).repeat(0),mushiTween.onComplete(function(){mushiBox.rotation.y=0}),domEvent.addEventListener(mushiBox,"click",function(){des.innerHTML="Priest —— A healing expert.Skill: Heal  <span>Select? <span id='priest' class='choose'>Y</span>/<span>N</span></span>",document.getElementById("priest").addEventListener("click",choosePriest,!1),mushiTween.start()}),e.position.y-=10},onProgress,onError)});var objectloader=new THREE.ObjectLoader(manager);objectloader.load("./action/zhanshi.json",function(e){sceneAnimationClip=e.animations[0],(scene1=e).add(camera1);var n=new THREE.AmbientLight(4473924);n.intensity=4.2,scene1.add(n);var a=directionalLight.clone();a.position.set(0,10,-5),a.lookAt(new THREE.Vector3(-1,10,-10));var o=directionalLight2.clone();o.position.set(1,10,-10),o.lookAt(new THREE.Vector3(0,10,0)),scene1.add(a),scene1.add(o),(mixer0=new THREE.AnimationMixer(scene1)).clipAction(sceneAnimationClip).loop=!1});var objectloader2=new THREE.ObjectLoader(manager);objectloader2.load("./action/fashi.json",function(e){sceneAnimationClip=e.animations[0],scene2=e,scene2.add(camera2);var n=new THREE.AmbientLight(4473924);n.intensity=4.2,scene2.add(n);var a=directionalLight.clone();a.position.set(0,10,-5),a.lookAt(new THREE.Vector3(-1,10,-10));var o=directionalLight2.clone();o.position.set(1,10,-10),o.lookAt(new THREE.Vector3(0,10,0)),scene2.add(a),scene2.add(o),(mixer1=new THREE.AnimationMixer(scene2)).clipAction(sceneAnimationClip).loop=!1});var objectloader3=new THREE.ObjectLoader(manager);objectloader3.load("./action/mushi.json",function(e){sceneAnimationClip=e.animations[0],scene3=e,scene3.add(camera3);var n=new THREE.AmbientLight(4473924);n.intensity=4.2,scene3.add(n);var a=directionalLight.clone();a.position.set(0,10,-5),a.lookAt(new THREE.Vector3(-1,10,-10));var o=directionalLight2.clone();o.position.set(1,10,-10),o.lookAt(new THREE.Vector3(0,10,0)),scene3.add(a),scene3.add(o),(mixer2=new THREE.AnimationMixer(scene3)).clipAction(sceneAnimationClip).loop=!1});var scene4=new THREE.Scene,camera4=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,2e3);camera4.position.set(10,0,10),camera4.lookAt(new THREE.Vector3(0,0,0)),scene4.add(camera4);var loader1=new THREE.JSONLoader(manager);loader1.load("./modelassets/red.json",function(e,n){model=new THREE.Mesh(e,n[0]),model.scale.set(.5,.5,.5),model.name="red",redMushroom=model});var loader2=new THREE.JSONLoader(manager);loader2.load("./modelassets/green.json",function(e,n){model=new THREE.Mesh(e,n[0]),model.scale.set(.5,.5,.5),model.name="green",greenMushroom=model});var loader3=new THREE.JSONLoader(manager);loader3.load("./modelassets/gold.json",function(e,n){model=new THREE.Mesh(e,n[0]),model.scale.set(.5,.5,.5),model.name="gold",goldMushroom=model});var loader4=new THREE.JSONLoader(manager);loader4.load("./modelassets/train.json",function(e,n){model=new THREE.Mesh(e,n[0]),model.name="train",train=model});var objectloader4=new THREE.ObjectLoader(manager);objectloader4.load("./gamescene/scene.json",function(e){e.children[0].name="scene",scene4.add(e.children[0]),camera4.position.set(0,5,20),camera4.lookAt(new THREE.Vector3(0,5,0));var n=new THREE.AmbientLight(16777215),a=new THREE.DirectionalLight(16777215);a.position.set(-70,80,0);var o=new THREE.DirectionalLight(16777215);o.position.set(70,80,0),scene4.add(a),scene4.add(o),scene4.add(n),document.getElementById("start").addEventListener("click",function(){document.getElementById("selectMusic").pause(),document.getElementById("gamemusic").play(),new TWEEN.Tween(camera4.position).to({z:45},3e3).start().onComplete(function(){moveAndLookAt(camera4,new THREE.Vector3(0,150,0),new THREE.Vector3(0,5,0),{duration:3e3});var e=new TWEEN.Tween(camera4.rotation).to({z:-Math.PI/2},2e3);e.onComplete(function(){moveAndLookAt(camera4,new THREE.Vector3(-110,90,30),new THREE.Vector3(0,0,0),{duration:3e3}),tipsShow=!0;var e=document.getElementById("tips");document.getElementById("delete").onclick=function(){switch(character[0]){case"brave":document.getElementById("skillBox").style.marginLeft="0px";break;case"mage":document.getElementById("skillBox").style.marginLeft="-50px";break;case"priest":document.getElementById("skillBox").style.marginLeft="-100px"}tipsShow=!1,e.style.display="none",scoreShow=!0,HPShow=!0,skillShow=!0;for(n=0;n<5;n++)generateRedMushRoom();for(n=0;n<3;n++)generateGreenMushRoom();for(var n=0;n<1;n++)generateGoldMushRoom();generateTrainOnRail1(),generateTrainOnRail2(),generateTrainOnRail3(),generateTrainOnRail4()}}),tweenRotate.chain(e)});var e=document.getElementById("title"),n=document.getElementById("subTitle"),a=document.getElementById("start"),o=document.getElementById("world");document.body.removeChild(e),document.body.removeChild(n),document.body.removeChild(a),o.style.background="url(img/bc2.png) no-repeat",o.style.backgroundSize="cover",gameBegin=!0}),addBrave(),addMage(),addPriest(),animate()}),window.addEventListener("keydown",function(e){var n=e.keyCode;switch(37!=n&&38!=n&&39!=n&&40!=n||(model2.position.y=2.3,action1.play(),action2.play(),action3.play()),n){case 37:moveLeft();break;case 38:moveForward();break;case 39:moveRight();break;case 40:moveBack();break;case 32:useSkill()}}),window.addEventListener("keyup",function(e){model1.rotation.x=0,model3.rotation.x=0,mage.position.y=-.1,action1.stop(),action2.stop(),action3.stop(),walkStep=.5,run.pause()});