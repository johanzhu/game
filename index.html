<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script type="text/javascript" src="js/three.js" ></script>
		<script type="text/javascript" src="js/MTLLoader.js" ></script>
		<script type="text/javascript" src="js/OBJLoader.js" ></script>
		<script type="text/javascript" src="js/ObjectLoader.js" ></script>
		<script type="text/javascript" src="js/JSONLoader.js" ></script>
		<script type="text/javascript" src="js/AnimationMixer.js" ></script>
		<script type="text/javascript" src="js/threex.domevents.js"></script>
		<script type="text/javascript" src="js/tween.js"></script>
		<script type="text/javascript" src="js/rotate.js" ></script>
	</head>
	<style>
	  body,html{width: 100%;height: 100%;margin: 0;padding: 0;overflow: hidden;}
	  @font-face {
	  	font-family: title;
	  	src: url('./font/AgencyFB.ttf') format('truetype');
	  }
		#world{
			width: 100%;
			height: 100%;
			background: url(img/bc.png);
			background-size: cover;
		}	
		#title{
			position: absolute;
			width: 324px;
			font-size: 50px;
			font-family: title;
			top: 10%;
			left: 50%;
			margin-left: -162px;
		}
		#subTitle{
			position: absolute;
			width: 324px;
			text-align: center;
			font-size: 30px;
			font-family: title;
			top: 20%;
			left: 50%;
			margin-left: -162px;
		}
		#vocationDes{
			position: absolute;
			text-align: center;
			width: 320px;
			font-size: 25px;
			font-family: title;
			white-space: no-wrap;
			top: 28%;
			left: 50%;
			margin-left: -160px;
		}
		.choose{
			cursor: pointer;
		}
		#start{
			position: absolute;
			bottom: 5%;
			left: 50%;
			width: 100px;
			height: 30px;
			font-size: 40px;
			margin-left: -50px;
			padding: 5px 0;
			line-height: 30px;
			text-align: center;
			color: black;
			font-family: title;
			border: 2px solid black;
			cursor: pointer;
			display: none;
		}
	</style>
	<body>
		<div id="world">
			<!--场景-->
		</div>
		<div id="title">
			Mushroom And Train
		</div>
		<div id="subTitle">
			Choose your vocation !
		</div>
		<div id="vocationDes">
		</div>
		<div id="start">Start</div>
		<audio src="music/selectmusic.mp3" autoplay="autoplay" loop="loop" preload="auto" id="selectMusic"></audio>
		<audio src="music/gamemusic.mp3" loop="loop" id="gamemusic"></audio>
		<script>
      var scene0,
          scene1,
		  camera0,
		  camera1,
		  mixer0,
		  mixer1,
		  mixer2,
		  mixerBrave,
		  mixerMage,
		  mixerPriest,
		  renderer;
	  var selected = false;
	      gameBegin = false;
	      character = [];
	      clock = new THREE.Clock();
		  scene0 = new THREE.Scene();
		  camera0 = new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,2000);
		  camera0.position.set(0,5,50);
		  camera0.lookAt(new THREE.Vector3(0,0,0));
		  camera1 = new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,2000);
		  camera1.position.set(0,5,-40);
		  camera1.lookAt(new THREE.Vector3(0,10,0));
		  camera2 = camera1.clone();
		  camera3 = camera1.clone();
		  camera4 = camera1.clone();
		  renderer = new THREE.WebGLRenderer({alpha:true,antialias:true});
		  renderer.setSize(window.innerWidth,window.innerHeight);
		  renderer.shadowMapEnabled = true;
		  var container =  document.getElementById('world');
		  container.appendChild(renderer.domElement);
		  window.addEventListener('resize',onWindowResize,false);
		  function onWindowResize(){
	        WIDTH=window.innerWidth;
	        HEIGHT=window.innerHeight;
            renderer.setSize(WIDTH, HEIGHT);
            camera0.aspect = WIDTH / HEIGHT;
            camera0.updateProjectionMatrix();
            camera1.aspect = WIDTH / HEIGHT;
            camera1.updateProjectionMatrix();
            camera2.aspect = WIDTH / HEIGHT;
            camera2.updateProjectionMatrix();
            camera3.aspect = WIDTH / HEIGHT;
            camera3.updateProjectionMatrix();
            camera4.aspect = WIDTH / HEIGHT;
            camera4.updateProjectionMatrix();
          }
		  /*scene0*/
		  var ambient = new THREE.AmbientLight( 0x444444 );
		  ambient.intensity = 3.2;
		  scene0.add( ambient );
		  var directionalLight = new THREE.DirectionalLight( 0xff0000);
		  directionalLight.position.set( -1, 1, 10 );
		  directionalLight.intensity = 0.1;
		  scene0.add( directionalLight );
		  var directionalLight2 = new THREE.DirectionalLight( 0xffeedd );
		  directionalLight2.position.set( 1, 1, 10 );
		  directionalLight2.intensity = 0.1;
		  scene0.add( directionalLight2 );
		  
		  var domEvent = new THREEx.DomEvents(camera0,renderer.domElement);
		  var des = document.getElementById('vocationDes'); 
		  
		  var arrowShape = new THREE.Shape();
		  arrowShape.moveTo(0,0);
		  arrowShape.lineTo(-2.5,-4.325);
		  arrowShape.lineTo(0,-2.1);
		  arrowShape.lineTo(2.5,-4.325);
		  arrowShape.lineTo(0,0);
		  var options = {
		  	amount: 2,
		  	bevelThickness: 0,
		  	bevelSize: 1,
		  	bevelSegments: 3,
		  	curveSegments: 12,
		  	step: 1
		  };
		  var arrowGeo = new THREE.ExtrudeGeometry(arrowShape,options);
		  var arrowMat = new THREE.MeshLambertMaterial({color:0xffffff});
		  var arrow = new THREE.Mesh(arrowGeo,arrowMat);
		  arrow.scale.set(0.5,0.5,0.5);
		  var arrow2 = arrow.clone();
		  var arrow3 = arrow.clone();
		  
	  /*人物选择*/
	    var onProgress = function ( xhr ) {
		if ( xhr.lengthComputable ) {
			var percentComplete = xhr.loaded / xhr.total * 100;
					}
				};
        var onError = function ( xhr ) { console.log('opps..cannot find model') };
        var mtlLoader1 = new THREE.MTLLoader();
        mtlLoader1.setPath( 'modelassets/' );
        mtlLoader1.load( 'chr-zhanshi.mtl', function( materials ) {
          materials.preload();
          var objLoader1 = new THREE.OBJLoader();
          objLoader1.setMaterials( materials );
          objLoader1.setPath( 'modelassets/' );
          objLoader1.load( 'chr-zhanshi.obj', function ( object ) {
            zhanshi = object;
            zhanshiBox = new THREE.Object3D();
            zhanshiBox.add(zhanshi);
            zhanshiBox.position.x -= 20;
            arrow.position.set(-20,-12,0);
            var tweenD = new TWEEN.Tween(arrow.position).to({y:-13},500);
            var tweenU = new TWEEN.Tween(arrow.position).to({y:-12},500);
            tweenD.chain(tweenU);
            tweenU.chain(tweenD);
            tweenD.start();
            scene0.add(arrow);
		    scene0.add( zhanshiBox );
		    zhanshiTween = new TWEEN.Tween(zhanshiBox.rotation).to({y:-2*Math.PI},2500).repeat(0);
		    zhanshiTween.onComplete(function(){zhanshiBox.rotation.y = 0});
		    domEvent.addEventListener(zhanshiBox,'click',zhanshiEvent);
		    function zhanshiEvent(){
		    	des.innerHTML = "Brave — A powerful soldier.Skill: Charge <span>Select?</span> <span id='brave' class='choose'>Y</span>/<span>N</span>";
		    	var braveSelect = document.getElementById('brave');
		    	braveSelect.addEventListener('click',chooseBrave,false);
		    	zhanshiTween.start();
		    };
		    object.position.y -= 10;
		  }, onProgress, onError );
		});
	    var mtlLoader2 = new THREE.MTLLoader();
        mtlLoader2.setPath( 'modelassets/' );
        mtlLoader2.load( 'chr-fashi.mtl', function( materials ) {
          materials.preload();
          var objLoader2 = new THREE.OBJLoader();
          objLoader2.setMaterials( materials );
          objLoader2.setPath( 'modelassets/' );
          objLoader2.load( 'chr-fashi.obj', function ( object ) {
            fashi = object;
            fashi.position.x = -1;
            fashiBox = new THREE.Object3D();
            arrow2.position.set(0,-12,0);
            var tweenD = new TWEEN.Tween(arrow2.position).to({y:-13},500);
            var tweenU = new TWEEN.Tween(arrow2.position).to({y:-12},500);
            tweenD.chain(tweenU);
            tweenU.chain(tweenD);
            tweenD.start();
            scene0.add(arrow2);
            fashiBox.add(fashi);
		    scene0.add( fashiBox );
		    fashiTween = new TWEEN.Tween(fashiBox.rotation).to({y:-2*Math.PI},2500).repeat(0);
		    fashiTween.onComplete(function(){fashiBox.rotation.y = 0});
		    domEvent.addEventListener(fashiBox,'click',fashiEvent);
		    function fashiEvent(){
		    	des.innerHTML = "Mage —— A wise oracle.Skill: Flash <span>Select?</span> <span id='mage' class='choose'>Y</span>/<span>N</span>";
		    	var mageSelect = document.getElementById('mage');
		    	mageSelect.addEventListener('click',chooseMage,false);
		    	fashiTween.start();
		    };
		    object.position.y -= 10;
		  }, onProgress, onError );
		});
		var mtlLoader3 = new THREE.MTLLoader();
        mtlLoader3.setPath( 'modelassets/' );
        mtlLoader3.load( 'chr-mushi.mtl', function( materials ) {
          materials.preload();
          var objLoader3 = new THREE.OBJLoader();
          objLoader3.setMaterials( materials );
          objLoader3.setPath( 'modelassets/' );
          objLoader3.load( 'chr-mushi.obj', function ( object ) {
            mushi = object;
            mushiBox = new THREE.Object3D();
            mushi.position.set(0,0,-3);
            mushiBox.add(mushi);
            mushiBox.position.x += 20;
            arrow3.position.set(20,-12,0);
            var tweenD = new TWEEN.Tween(arrow3.position).to({y:-13},500);
            var tweenU = new TWEEN.Tween(arrow3.position).to({y:-12},500);
            tweenD.chain(tweenU);
            tweenU.chain(tweenD);
            tweenD.start();
            scene0.add(arrow3);
		    scene0.add( mushiBox );
		    mushiTween = new TWEEN.Tween(mushiBox.rotation).to({y:-2*Math.PI},2500).repeat(0);
		    mushiTween.onComplete(function(){mushiBox.rotation.y = 0});
		    domEvent.addEventListener(mushiBox,'click',mushiEvent);
		    function mushiEvent(){
		    	des.innerHTML = "Priest —— A healing expert.Skill: Heal  <span>Select? <span id='priest' class='choose'>Y</span>/<span>N</span></span>";
		    	var priestSelect = document.getElementById('priest');
		    	priestSelect.addEventListener('click',choosePriest,false);
		    	mushiTween.start();
		    };
		    object.position.y -= 10;
		  }, onProgress, onError );
		});
		/*scene1,2,3 人物动画*/
	  var objectloader = new THREE.ObjectLoader();
	  objectloader.load('./action/zhanshi.json',function(loadedScene){
        sceneAnimationClip = loadedScene.animations[0];
		scene1 = loadedScene;
		scene1.add(camera1);
		var ambient = new THREE.AmbientLight(0x444444);
		ambient.intensity = 4.2;
		scene1.add(ambient);
		var directionalLightClone = directionalLight.clone();
		directionalLightClone.position.set(0,10,-5);
		directionalLightClone.lookAt(new THREE.Vector3(-1,10,-10));
		var directionalLight2Clone = directionalLight2.clone();
		directionalLight2Clone.position.set(1,10,-10);
		directionalLight2Clone.lookAt(new THREE.Vector3(0,10,0));
		scene1.add(directionalLightClone);
		scene1.add(directionalLight2Clone);
		mixer0 = new THREE.AnimationMixer(scene1);
		mixer0.clipAction(sceneAnimationClip).loop = false;
		animate();
	  });
	  var objectloader2 = new THREE.ObjectLoader();
	  objectloader2.load('./action/fashi.json',function(loadedScene){
        sceneAnimationClip = loadedScene.animations[0];
		scene2 = loadedScene;
		scene2.add(camera2);
		var ambient = new THREE.AmbientLight(0x444444);
		ambient.intensity = 4.2;
		scene2.add(ambient);
		var directionalLightClone = directionalLight.clone();
		directionalLightClone.position.set(0,10,-5);
		directionalLightClone.lookAt(new THREE.Vector3(-1,10,-10));
		var directionalLight2Clone = directionalLight2.clone();
		directionalLight2Clone.position.set(1,10,-10);
		directionalLight2Clone.lookAt(new THREE.Vector3(0,10,0));
		scene2.add(directionalLightClone);
		scene2.add(directionalLight2Clone);
		mixer1 = new THREE.AnimationMixer(scene2);
		mixer1.clipAction(sceneAnimationClip).loop = false;
		animate();
	  });
	  var objectloader3 = new THREE.ObjectLoader();
	  objectloader3.load('./action/mushi.json',function(loadedScene){
        sceneAnimationClip = loadedScene.animations[0];
		scene3 = loadedScene;
		scene3.add(camera3);
		var ambient = new THREE.AmbientLight(0x444444);
		ambient.intensity = 4.2;
		scene3.add(ambient);
		var directionalLightClone = directionalLight.clone();
		directionalLightClone.position.set(0,10,-5);
		directionalLightClone.lookAt(new THREE.Vector3(-1,10,-10));
		var directionalLight2Clone = directionalLight2.clone();
		directionalLight2Clone.position.set(1,10,-10);
		directionalLight2Clone.lookAt(new THREE.Vector3(0,10,0));
		scene3.add(directionalLightClone);
		scene3.add(directionalLight2Clone);
		mixer2 = new THREE.AnimationMixer(scene3);
		mixer2.clipAction(sceneAnimationClip).loop = false;
		animate();
	  });
	  /*游戏场景*/
	  var scene4 = new THREE.Scene();
	  var camera4 = new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,2000);
      camera4.position.set(10,0,10);
      camera4.lookAt(new THREE.Vector3(0,0,0));
      scene4.add(camera4);
      
      var objectloader4 = new THREE.ObjectLoader();
      objectloader4.load('./gamescene/train.json',function( loadedScene ){
      /*设定场景*/	
		scene4.add(loadedScene.children[0]);
		camera4.position.set(0,5,20);
		camera4.lookAt(new THREE.Vector3(0,5,0));
		var ambient = new THREE.AmbientLight(0xffffff);
		var dl = new THREE.DirectionalLight(0xffffff);
		dl.position.set(-70,80,0);
		var dr = new THREE.DirectionalLight(0xffffff);
		dr.position.set(70,80,0);
		scene4.add(dl);
		scene4.add(dr);
		scene4.add(ambient);
	/*定义开始按钮（此时人物选择完毕）*/
      	var start = document.getElementById('start');
	    start.addEventListener('click',function(){
	  	/*切换音乐*/
	  	var selectmusic = document.getElementById('selectMusic');
		selectmusic.pause();
		var gamemusic = document.getElementById('gamemusic');
		gamemusic.play();
		/*移动相机*/
		var cameraTween = new TWEEN.Tween(camera4.position).to({z:45},18000).start();
		cameraTween.onComplete(function(){
			moveAndLookAt(camera4,new THREE.Vector3(0,150,0),new THREE.Vector3(0,5,0),{duration:3000});
			var cameraRotate = new TWEEN.Tween(camera4.rotation).to({z:-Math.PI/2},2000);
			cameraRotate.onComplete(function(){
		      moveAndLookAt(camera4,new THREE.Vector3(-110,90,30),new THREE.Vector3(0,0,0),{duration:3000});
			});
			tweenRotate.chain(cameraRotate);
		});
	  	/*移除文字*/
	  	var title = document.getElementById('title');
	  	var subTitle = document.getElementById('subTitle');
	  	var start = document.getElementById('start');
	  	var bg = document.getElementById('world');
	  	document.body.removeChild(title);
	  	document.body.removeChild(subTitle);
	  	document.body.removeChild(start);
	  	bg.style.background = 'url(img/bc2.png) no-repeat';
	  	bg.style.backgroundSize = "cover";
	  	gameBegin = true;
	  });
	    addBrave();
	    addMage();
	    addPriest();
	    window.addEventListener('keydown',function(e){
         	if(e.keyCode === 38){
         	  brave.rotation.x = Math.PI*(22/180);
         	  priest.rotation.x = Math.PI*(24/180);
         	  priest.position.y = 3;
         	  mage.position.y = 5;
         	  action1.play();
              action2.play();
              action3.play();
         	}
         });
         window.addEventListener('keyup',function(e){
         	  brave.rotation.x = 0;
         	  priest.rotation.x = 0;
         	  priest.position.y = 1;
         	  mage.position.y = 0.9;
              action1.stop(); 
              action2.stop();
              action3.stop();
         });
		animate();
	  });
      
      
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  function animate(){
		requestAnimationFrame(animate);
		render();
	  }
	  function render(){
	  	var scene = scene0;
	  	var  camera = camera0;
	  	/*人物选择*/
	  	if(selected === true){
	  	  if(character[0] === 'brave'){
	  	  	scene = scene1;
	  	  	camera = camera1;
	  	  	mixer0.clipAction(sceneAnimationClip).play();
	  	  	scene4.remove(mage);
	  	  	scene4.remove(priest);
	  	  }else if(character[0] === 'mage'){
	  	  	scene = scene2;
	  	  	camera = camera2;
	  	  	mixer1.clipAction(sceneAnimationClip).play();
	  	  	scene4.remove(brave);
	  	  	scene4.remove(priest);
	  	  }else if(character[0] === 'priest'){
	  	  	scene = scene3;
	  	  	camera = camera3;
	  	  	mixer2.clipAction(sceneAnimationClip).play();
	  	  	scene4.remove(brave);
	  	  	scene4.remove(mage);
	  	  }
	  	}
	  	/*开始游戏*/
	  	if(gameBegin === true){
	  		scene = scene4;
	  		camera = camera4;
	  	}
	  	var delta = clock.getDelta();
	  	if(mixer0 && mixer1&& mixer2){
	  	  mixer0.update(delta);
	  	  mixer1.update(delta);
	  	  mixer2.update(delta);
	  	}
	  	if(mixerBrave){mixerBrave.update(delta);}
	  	if(mixerMage){mixerMage.update(delta);}
	  	if(mixerPriest){mixerPriest.update(delta);}
	  	
	  	TWEEN.update();
	    renderer.render(scene,camera);
     }
	 /*角色选择*/ 
	 function chooseBrave(){
	 	selected = true;
	 	character.push('brave');
	 	var des = document.getElementById('vocationDes');
	 	var start = document.getElementById('start');
	 	start.style.display = 'block';
	    document.body.removeChild(des);
	 }
	 function chooseMage(){
	 	selected = true;
	 	character.push('mage');
	 	var des = document.getElementById('vocationDes');
	 	var start = document.getElementById('start');
	 	start.style.display = 'block';
	    document.body.removeChild(des);
	 }
	 function choosePriest(){
	 	selected = true;
	 	character.push('priest');
	 	var des = document.getElementById('vocationDes');
	 	var start = document.getElementById('start');
	 	start.style.display = 'block';
	    document.body.removeChild(des);
	 }
	 /*角色添加*/
	function addBrave(){
		var loader = new THREE.JSONLoader();
		loader.load('./action/Zwalk.json',function(geo,mat){
	      for ( var i = 0; i < mat.length; i ++ ) {  
            var m = mat[ i ];  
            m.morphTargets = true;
          } 
          model1 = new THREE.Mesh(geo, mat[0]);
          brave = model1;
          model1.position.y =  1;
          scene4.add(model1);
            
         mixerBrave = new THREE.AnimationMixer( model1 );
	     var clip = THREE.AnimationClip.CreateFromMorphTargetSequence( 'brave', geo.morphTargets, 30 );
		 action1 = mixerBrave.clipAction( clip );
		 action1.setDuration( 1 );
         animate();
		});
	}
	function addMage(){
		var loader = new THREE.JSONLoader();
		loader.load('./action/Fwalk.json',function(geo,mat){
	      for ( var i = 0; i < mat.length; i ++ ) {  
            var m = mat[ i ];  
            m.morphTargets = true;
          } 
          model2 = new THREE.Mesh(geo, mat[0]);
          mage = model2;
          model2.position.y = 0.9;
          scene4.add(model2);
            
         mixerMage = new THREE.AnimationMixer( model2 );
	     var clip = THREE.AnimationClip.CreateFromMorphTargetSequence( 'mage', geo.morphTargets, 30 );
		 action2 = mixerMage.clipAction( clip );
		 action2.setDuration( 1 );
         animate();
		});
	}
	function addPriest(){
		var loader = new THREE.JSONLoader();
		loader.load('./action/Mwalk.json',function(geo,mat){
	      for ( var i = 0; i < mat.length; i ++ ) {  
            var m = mat[ i ];  
            m.morphTargets = true;
          } 
          model3 = new THREE.Mesh(geo, mat[0]);
          priest = model3;
          model3.position.y = 1;
          scene4.add(model3);
            
         mixerPriest = new THREE.AnimationMixer( model3 );
	     var clip = THREE.AnimationClip.CreateFromMorphTargetSequence( 'priest', geo.morphTargets, 30 );
		 action3 = mixerPriest.clipAction( clip );
		 action3.setDuration( 1 );
         animate();
		});
	}
	</script>
	</body>
</html>
